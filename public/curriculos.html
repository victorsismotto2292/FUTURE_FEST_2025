<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Currículos - WORKIN</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-icons/1.11.1/font/bootstrap-icons.min.css">
    <link rel="stylesheet" href="/style/curriculos.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Jockey+One&display=swap" rel="stylesheet">
</head>
<body>
    <div class="background-particles">
        <div class="particle"></div>
        <div class="particle"></div>
        <div class="particle"></div>
        <div class="particle"></div>
        <div class="particle"></div>
        <div class="particle"></div>
        <div class="particle"></div>
        <div class="particle"></div>
    </div>

    <nav class="bar">
        <img class="img2_logo" src="/img/image2.png" alt="WORKIN Logo">
        <h4 style="display: flex; justify-content: space-between; gap: 30px;">
            <a href="/">Home</a>            <a href="/planos">Planos e Preços</a>
            <a href="/aprender">Aprender</a>
            <a href="/parceria">Parceria</a>
            <a href="/comunidade">Comunidade</a>
            <a href="/suporte">Suporte</a>
            <a href="/perfil">Perfil</a>
            <a href="/logout">Logout</a>
        </h4>
    </nav>

    <div class="progress-container">
        <div class="progress" role="progressbar">
            <div class="progress-bar" id="progressBar" style="width: 0%"></div>
        </div>
        <div class="progress-steps">
            <span id="currentStep">1</span> de 8 passos
        </div>
    </div>

    <main class="main">
        <div class="welcome-section">
            <h1>Monte Seu Currículo Profissional</h1>
            <p>Crie um currículo impressionante e personalizado. Preencha todas as seções para obter o melhor resultado.</p>
            <img class="img1_logo" src="/img/image1.png" alt="Work.In Logo">
        </div>

        <div style="text-align: center; margin-bottom: 20px;">
            <a href="/my-curriculums" class="btn-primary" style="text-decoration: none; padding: 10px 25px; background: rgba(255,255,255,0.1); border: 2px solid #FFDD00; color: #FFDD00;">
                <i class="bi bi-folder-symlink"></i> Ver Meus Currículos Salvos
            </a>
        </div>

        <div class="resume-builder">
            <div class="form-navigation">
                <button class="nav-btn active" data-step="1">
                    <i class="bi bi-person-circle"></i>
                    <span>Pessoal</span>
                </button>
                <button class="nav-btn" data-step="2">
                    <i class="bi bi-briefcase"></i>
                    <span>Experiência</span>
                </button>
                <button class="nav-btn" data-step="3">
                    <i class="bi bi-mortarboard"></i>
                    <span>Educação</span>
                </button>
                <button class="nav-btn" data-step="4">
                    <i class="bi bi-star"></i>
                    <span>Habilidades</span>
                </button>
                <button class="nav-btn" data-step="5">
                    <i class="bi bi-award"></i>
                    <span>Certificações</span>
                </button>
                <button class="nav-btn" data-step="6">
                    <i class="bi bi-folder"></i>
                    <span>Projetos</span>
                </button>
                <button class="nav-btn" data-step="7">
                    <i class="bi bi-link-45deg"></i>
                    <span>Links</span>
                </button>
                <button class="nav-btn" data-step="8">
                    <i class="bi bi-check-circle"></i>
                    <span>Finalizar</span>
                </button>
            </div>

            <form id="resumeForm" class="resume-form">
                <!-- Step 1: Informações Pessoais -->
                <div class="form-step active" id="step1">
                    <h3><i class="bi bi-person-circle"></i> Informações Pessoais</h3>
                    <div class="form-row">
                        <div class="form-group col-md-6">
                            <label for="nome" class="form-label">
                                <i class="bi bi-person"></i> Nome Completo *
                            </label>
                            <input type="text" class="form-control" id="nome" name="nome" placeholder="Digite seu nome completo" required>
                        </div>
                        <div class="form-group col-md-6">
                            <label for="sobrenome" class="form-label">
                                <i class="bi bi-person"></i> Sobrenome *
                            </label>
                            <input type="text" class="form-control" id="sobrenome" name="sobrenome" placeholder="Digite seu sobrenome" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group col-md-6">
                            <label for="email" class="form-label">
                                <i class="bi bi-envelope"></i> E-mail *
                            </label>
                            <input type="email" class="form-control" id="email" name="email" placeholder="seuemail@exemplo.com" required>
                        </div>
                        <div class="form-group col-md-6">
                            <label for="telefone" class="form-label">
                                <i class="bi bi-telephone"></i> Telefone *
                            </label>
                            <input type="tel" class="form-control" id="telefone" name="telefone" placeholder="(11) 99999-9999" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group col-md-4">
                            <label for="cidade" class="form-label">
                                <i class="bi bi-geo-alt"></i> Cidade *
                            </label>
                            <input type="text" class="form-control" id="cidade" name="cidade" placeholder="Sua cidade" required>
                        </div>
                        <div class="form-group col-md-4">
                            <label for="estado" class="form-label">
                                <i class="bi bi-geo-alt"></i> Estado *
                            </label>
                            <input type="text" class="form-control" id="estado" name="estado" placeholder="Seu estado" required>
                        </div>
                        <div class="form-group col-md-4">
                            <label for="cep" class="form-label">
                                <i class="bi bi-geo-alt"></i> CEP
                            </label>
                            <input type="text" class="form-control" id="cep" name="cep" placeholder="00000-000">
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="foto" class="form-label">
                            <i class="bi bi-camera"></i> Foto de Perfil
                        </label>
                        <input type="file" class="form-control" id="foto" name="foto" accept="image/*">
                        <small style="color: white; font-size: small;">Formato recomendado: JPG, PNG. Tamanho máximo: 2MB</small>
                    </div>
                    <div class="form-group">
                        <label for="resumo" class="form-label">
                            <i class="bi bi-card-text"></i> Resumo Profissional *
                        </label>
                        <textarea class="form-control" id="resumo" name="resumo" rows="4" placeholder="Descreva brevemente sua trajetória profissional, objetivos e principais competências..." required></textarea>
                        <small class="form-text text-muted">Máximo 500 caracteres</small>
                    </div>
                    <div class="form-group">
                        <label for="objetivo" class="form-label">
                            <i class="bi bi-target"></i> Objetivo Profissional
                        </label>
                        <textarea class="form-control" id="objetivo" name="objetivo" rows="3" placeholder="Qual cargo você busca? Quais são seus objetivos profissionais?"></textarea>
                    </div>
                </div>

                <!-- Step 2: Experiência Profissional -->
                <div class="form-step" id="step2">
                    <h3><i class="bi bi-briefcase"></i> Experiência Profissional</h3>
                    <div id="experienceList">
                        <!-- Dynamic experiences will be added here -->
                    </div>
                    <button type="button" class="btn-add" onclick="addExperience()">
                        <i class="bi bi-plus-circle"></i> Adicionar Experiência
                    </button>
                </div>

                <!-- Step 3: Educação -->
                <div class="form-step" id="step3">
                    <h3><i class="bi bi-mortarboard"></i> Educação</h3>
                    <div id="educationList">
                        <!-- Dynamic education will be added here -->
                    </div>
                    <button type="button" class="btn-add" onclick="addEducation()">
                        <i class="bi bi-plus-circle"></i> Adicionar Formação
                    </button>
                </div>

                <!-- Step 4: Habilidades -->
                <div class="form-step" id="step4">
                    <h3><i class="bi bi-star"></i> Habilidades</h3>
                    <div id="skillsList">
                        <!-- Dynamic skills will be added here -->
                    </div>
                    <button type="button" class="btn-add" onclick="addSkill()">
                        <i class="bi bi-plus-circle"></i> Adicionar Habilidade
                    </button>
                </div>

                <!-- Step 5: Certificações -->
                <div class="form-step" id="step5">
                    <h3><i class="bi bi-award"></i> Certificações e Cursos</h3>
                    <div id="certificationsList">
                        <!-- Dynamic certifications will be added here -->
                    </div>
                    <button type="button" class="btn-add" onclick="addCertification()">
                        <i class="bi bi-plus-circle"></i> Adicionar Certificação
                    </button>
                </div>

                <!-- Step 6: Projetos -->
                <div class="form-step" id="step6">
                    <h3><i class="bi bi-folder"></i> Projetos</h3>
                    <div id="projectsList">
                        <!-- Dynamic projects will be added here -->
                    </div>
                    <button type="button" class="btn-add" onclick="addProject()">
                        <i class="bi bi-plus-circle"></i> Adicionar Projeto
                    </button>
                </div>

                <!-- Step 7: Links e Redes Sociais -->
                <div class="form-step" id="step7">
                    <h3><i class="bi bi-link-45deg"></i> Links e Redes Sociais</h3>
                    <div class="form-group">
                        <label for="linkedin" class="form-label">
                            <i class="bi bi-linkedin"></i> LinkedIn
                        </label>
                        <input type="url" class="form-control" id="linkedin" name="linkedin" placeholder="https://linkedin.com/in/seu-perfil">
                    </div>
                    <div class="form-group">
                        <label for="github" class="form-label">
                            <i class="bi bi-github"></i> GitHub
                        </label>
                        <input type="url" class="form-control" id="github" name="github" placeholder="https://github.com/seu-usuario">
                    </div>
                    <div class="form-group">
                        <label for="portfolio" class="form-label">
                            <i class="bi bi-globe"></i> Portfólio/Página Pessoal
                        </label>
                        <input type="url" class="form-control" id="portfolio" name="portfolio" placeholder="https://seu-portfolio.com">
                    </div>
                    <div class="form-group">
                        <label for="site" class="form-label">
                            <i class="bi bi-link"></i> Site da Empresa
                        </label>
                        <input type="url" class="form-control" id="site" name="site" placeholder="https://sua-empresa.com">
                    </div>
                </div>

                <!-- Step 8: Finalizar -->
                <div class="form-step" id="step8">
                    <h3><i class="bi bi-check-circle"></i> Finalizar Currículo</h3>
                    <div class="final-summary">
                        <h4>Resumo do seu currículo:</h4>
                        <div id="resumeSummary">
                            <!-- Summary will be populated here -->
                        </div>
                    </div>
                    <div class="form-actions">
                        <button type="button" class="btn-preview" onclick="previewResume()">
                            <i class="bi bi-eye"></i> Visualizar
                        </button>
                        <button type="submit" class="btn-submit">
                            <i class="bi bi-download"></i> Gerar Currículo
                        </button>
                    </div>
                </div>
            </form>

            <div class="form-controls">
                <button type="button" class="btn-secondary" id="prevBtn" disabled>
                    <i class="bi bi-arrow-left"></i> Anterior
                </button>
                <button type="button" class="btn-primary" id="nextBtn">
                    Próximo <i class="bi bi-arrow-right"></i>
                </button>
            </div>
        </div>
    </main>

<div class="modal fade" id="previewModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Visualização do Currículo</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="previewContent">
                    </div>
                <div class="modal-footer">
                    <button type="button" class="btn-secondary" data-bs-dismiss="modal">Fechar</button>
                    <button type="button" class="btn-primary" onclick="downloadResume()">
                        <i class="bi bi-download"></i> Baixar PDF
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        let currentStep = 1;
        const totalSteps = 8;
        let experienceCount = 0;
        let educationCount = 0;
        let skillCount = 0;
        let certificationCount = 0;
        let projectCount = 0;
        let editId = null; // Variável global para guardar o ID de edição

        // Initialize form
        document.addEventListener('DOMContentLoaded', function() {
            updateProgress();
            setupNavigation();

            const urlParams = new URLSearchParams(window.location.search);
            editId = urlParams.get('edit');

            if (editId) {
                // Modo Edição
                document.querySelector('.welcome-section h1').textContent = 'Editar Currículo';
                document.querySelector('.welcome-section p').textContent = 'Modifique as informações do seu currículo salvo.';
                document.querySelector('.btn-submit').innerHTML = '<i class="bi bi-save"></i> Salvar Alterações';
                loadCurriculumForEdit(editId);
            } else {
                // Modo Criação
                setupFormValidation(); // Configura validação para um formulário novo
                addExperience(); // Adiciona um campo de experiência por padrão
                addEducation(); // Adiciona um campo de educação por padrão
                addSkill(); // Adiciona um campo de habilidade por padrão
            }
        });

        // Carrega dados do currículo para edição
        function loadCurriculumForEdit(id) {
            fetch(`/get-curriculo/${id}`) // Rota do server.js
                .then(res => res.json())
                .then(data => {
                    if (data.curriculo) {
                        populateForm(data.curriculo);
                        setupFormValidation(); // Configura validação DEPOIS de preencher
                    } else {
                        alert('Erro: Currículo não encontrado.');
                        window.location.href = '/curriculos';
                    }
                })
                .catch(err => {
                    console.error('Erro ao carregar currículo:', err);
                    alert('Erro ao carregar currículo.');
                });
        }

        // Preenche o formulário com dados existentes
        function populateForm(data) {
            // Pessoal
            if (data.pessoal) {
                document.getElementById('nome').value = data.pessoal.nome || '';
                document.getElementById('sobrenome').value = data.pessoal.sobrenome || '';
                document.getElementById('email').value = data.pessoal.email || '';
                document.getElementById('telefone').value = data.pessoal.telefone || '';
                document.getElementById('cidade').value = data.pessoal.cidade || '';
                document.getElementById('estado').value = data.pessoal.estado || '';
                document.getElementById('cep').value = data.pessoal.cep || '';
                document.getElementById('resumo').value = data.pessoal.resumo || '';
                document.getElementById('objetivo').value = data.pessoal.objetivo || '';
            }
            
            // Links
            if (data.links) {
                document.getElementById('linkedin').value = data.links.linkedin || '';
                document.getElementById('github').value = data.links.github || '';
                document.getElementById('portfolio').value = data.links.portfolio || '';
                document.getElementById('site').value = data.links.site || '';
            }

            // Experiências (Recria dinamicamente)
            if (data.experiencias) {
                Object.values(data.experiencias).forEach(exp => {
                    addExperience(); // Isso incrementa experienceCount
                    document.querySelector(`input[name="empresa${experienceCount}"]`).value = exp.empresa || '';
                    document.querySelector(`input[name="cargo${experienceCount}"]`).value = exp.cargo || '';
                    document.querySelector(`input[name="dataInicio${experienceCount}"]`).value = exp.dataInicio || '';
                    document.querySelector(`input[name="dataFim${experienceCount}"]`).value = exp.dataFim || '';
                    document.querySelector(`input[name="atual${experienceCount}"]`).checked = exp.atual || false;
                    document.querySelector(`input[name="localizacao${experienceCount}"]`).value = exp.localizacao || '';
                    document.querySelector(`textarea[name="descExperiencia${experienceCount}"]`).value = exp.descricao || '';
                });
            }
            
            // Educação
            if (data.educacao) {
                Object.values(data.educacao).forEach(edu => {
                    addEducation(); // Increments educationCount
                    document.querySelector(`input[name="instituicao${educationCount}"]`).value = edu.instituicao || '';
                    document.querySelector(`input[name="curso${educationCount}"]`).value = edu.curso || '';
                    document.querySelector(`input[name="conclusao${educationCount}"]`).value = edu.conclusao || '';
                    document.querySelector(`input[name="cursando${educationCount}"]`).checked = edu.cursando || false;
                    document.querySelector(`input[name="localEdu${educationCount}"]`).value = edu.localizacao || '';
                    document.querySelector(`input[name="nota${educationCount}"]`).value = edu.nota || '';
                });
            }

            // Habilidades
            if (data.habilidades) {
                Object.values(data.habilidades).forEach(skill => {
                    addSkill(); // Increments skillCount
                    document.querySelector(`input[name="habilidade${skillCount}"]`).value = skill.nome || '';
                    document.querySelector(`select[name="nivel${skillCount}"]`).value = skill.nivel || '';
                });
            }

            // Certificações
            if (data.certificacoes) {
                Object.values(data.certificacoes).forEach(cert => {
                    addCertification(); // Increments certificationCount
                    document.querySelector(`input[name="certificacao${certificationCount}"]`).value = cert.nome || '';
                    document.querySelector(`input[name="emissor${certificationCount}"]`).value = cert.emissor || '';
                    document.querySelector(`input[name="dataEmissao${certificationCount}"]`).value = cert.dataEmissao || '';
                    document.querySelector(`input[name="dataExpiracao${certificationCount}"]`).value = cert.dataExpiracao || '';
                    document.querySelector(`input[name="credencial${certificationCount}"]`).value = cert.credencial || '';
                });
            }

            // Projetos
            if (data.projetos) {
                Object.values(data.projetos).forEach(proj => {
                    addProject(); // Increments projectCount
                    document.querySelector(`input[name="nomeProjeto${projectCount}"]`).value = proj.nome || '';
                    document.querySelector(`input[name="linkProjeto${projectCount}"]`).value = proj.link || '';
                    document.querySelector(`input[name="dataProjeto${projectCount}"]`).value = proj.data || '';
                    document.querySelector(`input[name="tecnologias${projectCount}"]`).value = proj.tecnologias || '';
                    document.querySelector(`textarea[name="descProjeto${projectCount}"]`).value = proj.descricao || '';
                });
            }
        }


        // Navigation functions
        function setupNavigation() {
            const navBtns = document.querySelectorAll('.nav-btn');
            navBtns.forEach(btn => {
                btn.addEventListener('click', function() {
                    const step = parseInt(this.dataset.step);
                    goToStep(step);
                });
            });

            document.getElementById('prevBtn').addEventListener('click', () => goToStep(currentStep - 1));
            document.getElementById('nextBtn').addEventListener('click', () => goToStep(currentStep + 1));
        }

        function goToStep(step) {
            if (step < 1 || step > totalSteps) return;

            // Hide current step
            document.getElementById(`step${currentStep}`).classList.remove('active');
            document.querySelector(`[data-step="${currentStep}"]`).classList.remove('active');

            // Show new step
            currentStep = step;
            document.getElementById(`step${currentStep}`).classList.add('active');
            document.querySelector(`[data-step="${currentStep}"]`).classList.add('active');

            updateProgress();
            updateNavigationButtons();
        }

        function updateProgress() {
            const progress = (currentStep / totalSteps) * 100;
            document.getElementById('progressBar').style.width = `${progress}%`;
            document.getElementById('currentStep').textContent = currentStep;
        }

        function updateNavigationButtons() {
            const prevBtn = document.getElementById('prevBtn');
            const nextBtn = document.getElementById('nextBtn');

            prevBtn.disabled = currentStep === 1;
            nextBtn.textContent = currentStep === totalSteps ? 'Finalizar' : 'Próximo';
            nextBtn.innerHTML = currentStep === totalSteps ? '<i class="bi bi-check"></i> Finalizar' : 'Próximo <i class="bi bi-arrow-right"></i>';
        }

        // Dynamic form functions
        function addExperience() {
            experienceCount++;
            const experienceList = document.getElementById('experienceList');
            const experienceDiv = document.createElement('div');
            experienceDiv.className = 'dynamic-item experience-item';
            experienceDiv.innerHTML = `
                <div class="item-header">
                    <h5>Experiência ${experienceCount}</h5>
                    <button type="button" class="btn-remove" onclick="removeItem(this)">
                        <i class="bi bi-trash"></i>
                    </button>
                </div>
                <div class="form-row">
                    <div class="form-group col-md-6">
                        <label class="form-label"><i class="bi bi-building"></i> Empresa *</label>
                        <input type="text" class="form-control" name="empresa${experienceCount}" placeholder="Nome da empresa" required>
                    </div>
                    <div class="form-group col-md-6">
                        <label class="form-label"><i class="bi bi-person-badge"></i> Cargo *</label>
                        <input type="text" class="form-control" name="cargo${experienceCount}" placeholder="Seu cargo" required>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group col-md-3">
                        <label class="form-label"><i class="bi bi-calendar"></i> Data Início *</label>
                        <input type="month" class="form-control" name="dataInicio${experienceCount}" required>
                    </div>
                    <div class="form-group col-md-3">
                        <label class="form-label"><i class="bi bi-calendar-check"></i> Data Fim</label>
                        <input type="month" class="form-control" name="dataFim${experienceCount}">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="atual${experienceCount}" id="atual${experienceCount}">
                            <label class="form-check-label" for="atual${experienceCount}">Emprego atual</label>
                        </div>
                    </div>
                    <div class="form-group col-md-6">
                        <label class="form-label"><i class="bi bi-geo-alt"></i> Localização</label>
                        <input type="text" class="form-control" name="localizacao${experienceCount}" placeholder="Cidade, Estado">
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label"><i class="bi bi-card-text"></i> Descrição das Responsabilidades *</label>
                    <textarea class="form-control" name="descExperiencia${experienceCount}" rows="4" placeholder="Descreva suas principais responsabilidades, conquistas e resultados obtidos..." required></textarea>
                </div>
            `;
            experienceList.appendChild(experienceDiv);
        }

        function addEducation() {
            educationCount++;
            const educationList = document.getElementById('educationList');
            const educationDiv = document.createElement('div');
            educationDiv.className = 'dynamic-item education-item';
            educationDiv.innerHTML = `
                <div class="item-header">
                    <h5>Formação ${educationCount}</h5>
                    <button type="button" class="btn-remove" onclick="removeItem(this)">
                        <i class="bi bi-trash"></i>
                    </button>
                </div>
                <div class="form-row">
                    <div class="form-group col-md-6">
                        <label class="form-label"><i class="bi bi-mortarboard-fill"></i> Instituição *</label>
                        <input type="text" class="form-control" name="instituicao${educationCount}" placeholder="Nome da instituição" required>
                    </div>
                    <div class="form-group col-md-6">
                        <label class="form-label"><i class="bi bi-book"></i> Curso/Grau *</label>
                        <input type="text" class="form-control" name="curso${educationCount}" placeholder="Nome do curso" required>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group col-md-4">
                        <label class="form-label"><i class="bi bi-calendar-check"></i> Data Conclusão</label>
                        <input type="month" class="form-control" name="conclusao${educationCount}">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="cursando${educationCount}" id="cursando${educationCount}">
                            <label class="form-check-label" for="cursando${educationCount}">Cursando</label>
                        </div>
                    </div>
                    <div class="form-group col-md-4">
                        <label class="form-label"><i class="bi bi-geo-alt"></i> Localização</label>
                        <input type="text" class="form-control" name="localEdu${educationCount}" placeholder="Cidade, Estado">
                    </div>
                    <div class="form-group col-md-4">
                        <label class="form-label"><i class="bi bi-star"></i> Nota/CR</label>
                        <input type="text" class="form-control" name="nota${educationCount}" placeholder="Ex: 8.5">
                    </div>
                </div>
            `;
            educationList.appendChild(educationDiv);
        }

        function addSkill() {
            skillCount++;
            const skillsList = document.getElementById('skillsList');
            const skillDiv = document.createElement('div');
            skillDiv.className = 'dynamic-item skill-item';
            skillDiv.innerHTML = `
                <div class="skill-input-group">
                    <div class="form-group flex-grow-1">
                        <label class="form-label"><i class="bi bi-star-fill"></i> Habilidade *</label>
                        <input type="text" class="form-control" name="habilidade${skillCount}" placeholder="Ex: JavaScript, Liderança, Photoshop" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label"><i class="bi bi-bar-chart"></i> Nível *</label>
                        <select class="form-control" name="nivel${skillCount}" required>
                            <option value="" style="background-color: black">Selecione</option>
                            <option value="Básico" style="background-color: black">Básico</option>
                            <option value="Intermediário" style="background-color: black">Intermediário</option>
                            <option value="Avançado" style="background-color: black">Avançado</option>
                            <option value="Especialista" style="background-color: black">Especialista</option>
                        </select>
                    </div>
                    <button type="button" class="btn-remove" onclick="removeItem(this)">
                        <i class="bi bi-trash"></i>
                    </button>
                </div>
            `;
            skillsList.appendChild(skillDiv);
        }

        function addCertification() {
            certificationCount++;
            const certificationsList = document.getElementById('certificationsList');
            const certificationDiv = document.createElement('div');
            certificationDiv.className = 'dynamic-item certification-item';
            certificationDiv.innerHTML = `
                <div class="item-header">
                    <h5>Certificação ${certificationCount}</h5>
                    <button type="button" class="btn-remove" onclick="removeItem(this)">
                        <i class="bi bi-trash"></i>
                    </button>
                </div>
                <div class="form-row">
                    <div class="form-group col-md-6">
                        <label class="form-label"><i class="bi bi-award"></i> Nome da Certificação *</label>
                        <input type="text" class="form-control" name="certificacao${certificationCount}" placeholder="Nome da certificação/curso" required>
                    </div>
                    <div class="form-group col-md-6">
                        <label class="form-label"><i class="bi bi-building"></i> Instituição Emissora *</label>
                        <input type="text" class="form-control" name="emissor${certificationCount}" placeholder="Nome da instituição" required>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group col-md-4">
                        <label class="form-label"><i class="bi bi-calendar-check"></i> Data de Emissão</label>
                        <input type="month" class="form-control" name="dataEmissao${certificationCount}">
                    </div>
                    <div class="form-group col-md-4">
                        <label class="form-label"><i class="bi bi-calendar-x"></i> Data de Expiração</label>
                        <input type="month" class="form-control" name="dataExpiracao${certificationCount}">
                    </div>
                    <div class="form-group col-md-4">
                        <label class="form-label"><i class="bi bi-link"></i> Credencial ID</label>
                        <input type="text" class="form-control" name="credencial${certificationCount}" placeholder="ID da credencial">
                    </div>
                </div>
            `;
            certificationsList.appendChild(certificationDiv);
        }

        function addProject() {
            projectCount++;
            const projectsList = document.getElementById('projectsList');
            const projectDiv = document.createElement('div');
            projectDiv.className = 'dynamic-item project-item';
            projectDiv.innerHTML = `
                <div class="item-header">
                    <h5>Projeto ${projectCount}</h5>
                    <button type="button" class="btn-remove" onclick="removeItem(this)">
                        <i class="bi bi-trash"></i>
                    </button>
                </div>
                <div class="form-row">
                    <div class="form-group col-md-6">
                        <label class="form-label"><i class="bi bi-folder"></i> Nome do Projeto *</label>
                        <input type="text" class="form-control" name="nomeProjeto${projectCount}" placeholder="Nome do projeto" required>
                    </div>
                    <div class="form-group col-md-6">
                        <label class="form-label"><i class="bi bi-link"></i> Link do Projeto</label>
                        <input type="url" class="form-control" name="linkProjeto${projectCount}" placeholder="https://github.com/...">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group col-md-6">
                        <label class="form-label"><i class="bi bi-calendar"></i> Data</label>
                        <input type="month" class="form-control" name="dataProjeto${projectCount}">
                    </div>
                    <div class="form-group col-md-6">
                        <label class="form-label"><i class="bi bi-code-slash"></i> Tecnologias</label>
                        <input type="text" class="form-control" name="tecnologias${projectCount}" placeholder="Ex: React, Node.js, MongoDB">
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label"><i class="bi bi-card-text"></i> Descrição *</label>
                    <textarea class="form-control" name="descProjeto${projectCount}" rows="3" placeholder="Descreva o projeto, suas responsabilidades e resultados..." required></textarea>
                </div>
            `;
            projectsList.appendChild(projectDiv);
        }

        function removeItem(button) {
            button.closest('.dynamic-item').remove();
        }

        // Form validation
        function setupFormValidation() {
            const form = document.getElementById('resumeForm');
            // Validação dinâmica nos campos
            form.querySelectorAll('input[required], textarea[required], select[required]').forEach(input => {
                input.addEventListener('blur', () => validateField(input));
            });
            
            // Validação no submit (usada pela função saveResumeToServer)
            form.addEventListener('submit', function(e) {
                e.preventDefault();
                
                if (currentStep !== totalSteps) {
                    goToStep(totalSteps); // Força ir para o último passo
                    return;
                }

                if (!validateRequiredFields()) {
                    goToStep(1); // Volta ao primeiro passo se houver erros
                    return;
                }

                saveResumeToServer();
            });
        }

        function validateField(field) {
            const value = field.value.trim();
            const isValid = value !== '';
            field.classList.toggle('is-invalid', !isValid);
            field.classList.toggle('is-valid', isValid);
            return isValid;
        }

        // Validação de campos obrigatórios
        function validateRequiredFields() {
            const requiredFields = [
                { id: 'nome', name: 'Nome Completo' },
                { id: 'sobrenome', name: 'Sobrenome' },
                { id: 'email', name: 'E-mail' },
                { id: 'telefone', name: 'Telefone' },
                { id: 'cidade', name: 'Cidade' },
                { id: 'estado', name: 'Estado' },
                { id: 'resumo', name: 'Resumo Profissional' }
            ];

            const emptyFields = [];

            requiredFields.forEach(field => {
                const element = document.getElementById(field.id);
                if (!element || !element.value.trim()) {
                    emptyFields.push(field.name);
                    if (element) {
                        element.classList.add('is-invalid');
                    }
                } else {
                    if (element) {
                        element.classList.remove('is-invalid');
                        element.classList.add('is-valid');
                    }
                }
            });
            
            // Validação de campos dinâmicos (simplificada, apenas checa o primeiro)
            if(experienceCount > 0 && !document.querySelector('input[name="empresa1"]')?.value) {
                emptyFields.push('Empresa (Experiência 1)');
            }
            if(educationCount > 0 && !document.querySelector('input[name="instituicao1"]')?.value) {
                emptyFields.push('Instituição (Educação 1)');
            }
             if(skillCount > 0 && !document.querySelector('input[name="habilidade1"]')?.value) {
                emptyFields.push('Habilidade (Habilidade 1)');
            }


            if (emptyFields.length > 0) {
                alert('Por favor, preencha os seguintes campos obrigatórios:\n\n' + emptyFields.join('\n'));
                return false;
            }

            return true;
        }

        // Preview and generation functions
        function previewResume() {
            const modal = new bootstrap.Modal(document.getElementById('previewModal'));
            const previewContent = document.getElementById('previewContent');
            const resumeData = collectFormData(); // Coleta os dados do formulário
            previewContent.innerHTML = generateResumeHTML(resumeData); // Gera o HTML do preview
            modal.show();
        }

        function generateResumeHTML(data) {
            // Usa a estrutura de dados nova (com 'pessoal', 'experiencias', etc.)
            const pessoal = data.pessoal || {};
            const experiencias = Object.values(data.experiencias || {});

            return `
                <div class="resume-preview" style="color: #333; font-family: Arial, sans-serif;">
                    <header class="resume-header" style="text-align: center; border-bottom: 2px solid #FFDD00; padding-bottom: 15px; margin-bottom: 20px;">
                        <div class="personal-info">
                            <h1 style="font-size: 28px; margin-bottom: 5px;">${escapeHtml(pessoal.nome)} ${escapeHtml(pessoal.sobrenome)}</h1>
                            <div class="contact-info" style="font-size: 14px; color: #555;">
                                <span><i class="bi bi-envelope"></i> ${escapeHtml(pessoal.email)}</span> |
                                <span><i class="bi bi-telephone"></i> ${escapeHtml(pessoal.telefone)}</span> |
                                <span><i class="bi bi-geo-alt"></i> ${escapeHtml(pessoal.cidade)}, ${escapeHtml(pessoal.estado)}</span>
                            </div>
                        </div>
                    </header>

                    <section class="resume-section" style="margin-bottom: 20px;">
                        <h2 style="font-size: 18px; font-weight: bold; color: #1B2C3E; border-bottom: 1px solid #eee; padding-bottom: 5px; margin-bottom: 10px;">Resumo Profissional</h2>
                        <p style="font-size: 14px; line-height: 1.6;">${escapeHtml(pessoal.resumo)}</p>
                    </section>

                    ${pessoal.objetivo ? `
                    <section class="resume-section" style="margin-bottom: 20px;">
                        <h2 style="font-size: 18px; font-weight: bold; color: #1B2C3E; border-bottom: 1px solid #eee; padding-bottom: 5px; margin-bottom: 10px;">Objetivo</h2>
                        <p style="font-size: 14px; line-height: 1.6;">${escapeHtml(pessoal.objetivo)}</p>
                    </section>
                    ` : ''}
                    
                    ${experiencias.length > 0 ? `
                    <section class="resume-section" style="margin-bottom: 20px;">
                        <h2 style="font-size: 18px; font-weight: bold; color: #1B2C3E; border-bottom: 1px solid #eee; padding-bottom: 5px; margin-bottom: 10px;">Experiência</h2>
                        ${experiencias.map(exp => `
                            <div style="margin-bottom: 15px;">
                                <h3 style="font-size: 16px; font-weight: bold;">${escapeHtml(exp.cargo)}</h3>
                                <h4 style="font-size: 14px; font-style: italic; color: #555;">${escapeHtml(exp.empresa)} | ${escapeHtml(exp.localizacao)}</h4>
                                <p style="font-size: 14px; line-height: 1.6;">${escapeHtml(exp.descricao)}</p>
                            </div>
                        `).join('')}
                    </section>
                    ` : ''}

                    <div class="resume-footer" style="text-align: center; margin-top: 30px; padding-top: 10px; border-top: 1px solid #eee; font-size: 12px; color: #999;">
                        <p>Currículo gerado em ${new Date().toLocaleDateString('pt-BR')}</p>
                    </div>
                </div>
            `;
        }
        
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }


        // Função para salvar currículo no servidor (MODIFICADA)
        function saveResumeToServer() {
            const resumeData = collectFormData(); // Coleta os dados
            
            // Define a URL e o Método (Criar NOVO ou Atualizar EXISTENTE)
            const url = editId ? `/update-curriculo/${editId}` : '/save-curriculo';
            const method = editId ? 'PUT' : 'POST';

            fetch(url, {
                method: method,
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(resumeData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert(editId ? 'Currículo atualizado com sucesso!' : 'Currículo salvo com sucesso!');
                    
                    // Salva no sessionStorage para visualização imediata
                    sessionStorage.setItem('curriculumData', JSON.stringify(resumeData));
                    
                    // Redireciona para a página de visualização
                    window.location.href = '/curriculum-view.html'; 
                } else {
                    alert('Erro ao salvar: ' + (data.message || 'Erro desconhecido'));
                }
            })
            .catch(error => {
                console.error('Erro:', error);
                alert('Erro ao salvar currículo. Por favor, tente novamente.');
            });
        }

        // Função para coletar dados do formulário
        function collectFormData() {
            const formData = new FormData(document.getElementById('resumeForm'));
            const data = {
                pessoal: {
                    nome: document.getElementById('nome').value,
                    sobrenome: document.getElementById('sobrenome').value,
                    email: document.getElementById('email').value,
                    telefone: document.getElementById('telefone').value,
                    cidade: document.getElementById('cidade').value,
                    estado: document.getElementById('estado').value,
                    cep: document.getElementById('cep').value,
                    resumo: document.getElementById('resumo').value,
                    objetivo: document.getElementById('objetivo').value
                },
                experiencias: {},
                educacao: {},
                habilidades: {},
                certificacoes: {},
                projetos: {},
                links: {
                    linkedin: document.getElementById('linkedin').value,
                    github: document.getElementById('github').value,
                    portfolio: document.getElementById('portfolio').value,
                    site: document.getElementById('site').value
                }
            };

            // Coletar experiências
            for (let i = 1; i <= experienceCount; i++) {
                const empresa = document.querySelector(`input[name="empresa${i}"]`);
                if (empresa && empresa.value) {
                    data.experiencias[`exp${i}`] = {
                        empresa: empresa.value,
                        cargo: document.querySelector(`input[name="cargo${i}"]`).value,
                        dataInicio: document.querySelector(`input[name="dataInicio${i}"]`).value,
                        dataFim: document.querySelector(`input[name="dataFim${i}"]`).value,
                        atual: document.querySelector(`input[name="atual${i}"]`)?.checked || false,
                        localizacao: document.querySelector(`input[name="localizacao${i}"]`).value,
                        descricao: document.querySelector(`textarea[name="descExperiencia${i}"]`).value
                    };
                }
            }

            // Coletar educação
            for (let i = 1; i <= educationCount; i++) {
                const instituicao = document.querySelector(`input[name="instituicao${i}"]`);
                if (instituicao && instituicao.value) {
                    data.educacao[`edu${i}`] = {
                        instituicao: instituicao.value,
                        curso: document.querySelector(`input[name="curso${i}"]`).value,
                        conclusao: document.querySelector(`input[name="conclusao${i}"]`).value,
                        cursando: document.querySelector(`input[name="cursando${i}"]`)?.checked || false,
                        localizacao: document.querySelector(`input[name="localEdu${i}"]`).value,
                        nota: document.querySelector(`input[name="nota${i}"]`).value
                    };
                }
            }

            // Coletar habilidades
            for (let i = 1; i <= skillCount; i++) {
                const habilidade = document.querySelector(`input[name="habilidade${i}"]`);
                if (habilidade && habilidade.value) {
                    data.habilidades[`skill${i}`] = {
                        nome: habilidade.value,
                        nivel: document.querySelector(`select[name="nivel${i}"]`).value
                    };
                }
            }

            // Coletar certificações
            for (let i = 1; i <= certificationCount; i++) {
                const certificacao = document.querySelector(`input[name="certificacao${i}"]`);
                if (certificacao && certificacao.value) {
                    data.certificacoes[`cert${i}`] = {
                        nome: certificacao.value,
                        emissor: document.querySelector(`input[name="emissor${i}"]`).value,
                        dataEmissao: document.querySelector(`input[name="dataEmissao${i}"]`).value,
                        dataExpiracao: document.querySelector(`input[name="dataExpiracao${i}"]`).value,
                        credencial: document.querySelector(`input[name="credencial${i}"]`).value
                    };
                }
            }

            // Coletar projetos
            for (let i = 1; i <= projectCount; i++) {
                const projeto = document.querySelector(`input[name="nomeProjeto${i}"]`);
                if (projeto && projeto.value) {
                    data.projetos[`proj${i}`] = {
                        nome: projeto.value,
                        link: document.querySelector(`input[name="linkProjeto${i}"]`).value,
                        data: document.querySelector(`input[name="dataProjeto${i}"]`).value,
                        tecnologias: document.querySelector(`input[name="tecnologias${i}"]`).value,
                        descricao: document.querySelector(`textarea[name="descProjeto${i}"]`).value
                    };
                }
            }

            // Se estiver editando, anexa o ID para a atualização
            if(editId) {
                data.id = editId;
            }

            return data;
        }

        // Função para gerar PDF (simplificada)
        function downloadResume() {
            const resumeData = collectFormData();
            
            // Criar conteúdo do PDF
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            let yPosition = 20;
            
            // Título
            doc.setFontSize(20);
            doc.setFont(undefined, 'bold');
            doc.text(`${resumeData.pessoal.nome} ${resumeData.pessoal.sobrenome}`, 20, yPosition);
            yPosition += 10;
            
            // Informações de contato
            doc.setFontSize(10);
            doc.setFont(undefined, 'normal');
            doc.text(`${resumeData.pessoal.email} | ${resumeData.pessoal.telefone}`, 20, yPosition);
            yPosition += 7;
            doc.text(`${resumeData.pessoal.cidade}, ${resumeData.pessoal.estado}`, 20, yPosition);
            yPosition += 15;
            
            // Resumo Profissional
            if (resumeData.pessoal.resumo) {
                doc.setFontSize(14);
                doc.setFont(undefined, 'bold');
                doc.text('Resumo Profissional', 20, yPosition);
                yPosition += 7;
                
                doc.setFontSize(10);
                doc.setFont(undefined, 'normal');
                const resumoLines = doc.splitTextToSize(resumeData.pessoal.resumo, 170);
                doc.text(resumoLines, 20, yPosition);
                yPosition += (resumoLines.length * 5) + 10;
            }
            
            // Salvar PDF
            doc.save(`curriculo_${resumeData.pessoal.nome}_${resumeData.pessoal.sobrenome}.pdf`);
        }

        // Atualizar o botão de download no modal
        const downloadBtn = document.querySelector('.modal-footer .btn-primary');
        if (downloadBtn) {
            downloadBtn.onclick = downloadResume;
        }

        // Preview de foto
        document.getElementById('foto')?.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(event) {
                    // Criar preview da imagem
                    let preview = document.getElementById('fotoPreview');
                    if (!preview) {
                        preview = document.createElement('img');
                        preview.id = 'fotoPreview';
                        preview.style.width = '100px';
                        preview.style.height = '100px';
                        preview.style.borderRadius = '50%';
                        preview.style.objectFit = 'cover';
                        preview.style.marginTop = '10px';
                        e.target.parentElement.appendChild(preview);
                    }
                    preview.src = event.target.result;
                };
                reader.readAsDataURL(file);
            }
        });
    
        // Chatbot
        (function(){if(!window.chatbase||window.chatbase("getState")!=="initialized"){window.chatbase=(...arguments)=>{if(!window.chatbase.q){window.chatbase.q=[]}window.chatbase.q.push(arguments)};window.chatbase=new Proxy(window.chatbase,{get(target,prop){if(prop==="q"){return target.q}return(...args)=>target(prop,...args)}})}const onLoad=function(){const script=document.createElement("script");script.src="https://www.chatbase.co/embed.min.js";script.id="jxCxiLH-axFwvOPfEOgyP";script.domain="www.chatbase.co";document.body.appendChild(script)};if(document.readyState==="complete"){onLoad()}else{window.addEventListener("load",onLoad)}})();
    </script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

</body>
</html>
</body>
</html>
